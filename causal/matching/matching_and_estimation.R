## ========================================================================== ##
# Project: Health Equity Payment

# Team: Improvement Analytics Unit (IAU) at the Health Foundation

# Script: matching_and_estimation.R

# Corresponding author:Sarah Opie-Martin (sarah.opie-martin@health.org.uk)

# Description:
# Perform specified matching and estimate causal effect

# Dependencies: preamble.R
#

# Inputs:
# cleaned data from LLR on payments
# public reference data file

# Outputs:
# Matched populations and ATT

# Notes:
## ========================================================================== ##


# setwd('')

source("~/causal/preamble.R")

### data files generated by 'clean_data.R script'
baseline <- readRDS("cleaned_data/baseline_data.rds")
payments <- readRDS("cleaned_data/practice_payments_cleaned.rds")
outcomes_2024 <- readRDS("cleaned_data/outcomes_2024.rds")

### panel of covariated used in matching
static_matching_panel <- c(
  "IMD_quintile",
  "NUMBER_OF_PATIENTS",
  "chi",
  "PERC_65",
  "PERC_MALE",
  "POP_WHITE",
  "POP_ENG2",
  "POP_RURAL",
  "gp_partner_1",
  "contract_type",
  "AST",
  "CKD",
  "COPD",
  "CHD",
  "DM",
  "HYP",
  # pre-intervention values of outcome measures
  "q28_12pct", "q18_12pct", "q90_12pct", "qof_percent", "total_gp_extg_fte_weighted", "total_nurses_fte_weighted", "total_admin_fte_weighted"
)

outcomes <- c("q18_12pct_POST_INT", "q28_12pct_POST_INT", "q90_12pct_POST_INT", "qof_percent_POST_INT", "total_gp_extg_fte_weighted_POST_INT", "total_nurses_fte_weighted_POST_INT", "total_admin_fte_weighted_POST_INT")
preintervention_outcomes <- c("q18_12pct", "q28_12pct", "q90_12pct", "qof_percent", "total_gp_extg_fte_weighted", "total_nurses_fte_weighted", "total_admin_fte_weighted")


baseline <- baseline %>%
  filter((LLR == "LLR" & treated == TRUE) | (LLR == "Not LLR" & treated == FALSE)) %>%
  filter(contract_type != "PMS") %>%
  mutate(
    IMD_quintile = as.factor(clean_quintile)
  ) %>%
  left_join(payments, by = c("PRACTICE_CODE" = "Practice.Code")) %>%
  left_join(outcomes_2024, by = "PRACTICE_CODE") %>%
  drop_na(all_of(static_matching_panel)) %>%
  drop_na(all_of(outcomes))

formula <- as.formula(paste("treated ~ ", paste(static_matching_panel, collapse = " + ")))

set.seed(1234)

m.out0 <- matchit(
  formula,
  data = baseline,
  method = "genetic",
  distance = "glm",
  pop.size = 1000,
  replace = FALSE
)

### save the matching object for loading later
saveRDS("matching_agreed_noPMS.rds")

### read maching file if using later
m.out0 <- readRDS("matching_agreed_noPMS.rds")

branding_colours <- c("#EB003B", "#189EDC")

new_names <- c(
  IMD_quintile = "IMD quintile",
  NUMBER_OF_PATIENTS = "List size",
  chi = "Carr-Hill Index",
  PERC_65 = "% of patients >65 years old",
  PERC_MALE = "% of male patients",
  POP_WHITE = "% of population is white",
  POP_ENG2 = "% of population with English as a second language",
  POP_RURAL = "% of population living in rural areas",
  gp_partner_1 = "Practice partner count",
  contract_type = "Practice contract type",
  AST = "Asthma prevalence",
  CKD = "Chronic kidney disease prevalence",
  COPD = "Chronic obstructive pulmonary disease prevalence",
  CHD = "Coronary heart disease prevalence",
  DM = "Diabetes mellitus prevalence",
  HYP = "Hypertension prevalence",
  q28_12pct = "% good overall experience of practice",
  q18_12pct = "% good experience of contact",
  q90_12pct = "% 'yes' needs met at appointment",
  qof_percent = "% overall QOF achievement",
  total_gp_extg_fte_weighted = "FTE GPs (excluding training grade) / 1000 weighted patients",
  total_nurses_fte_weighted = "FTE Nurses / 1000 weighted patients",
  total_admin_fte_weighted = "FTE admin / 1000 weighted patients"
)

### create figure 1
tiff("love_plot.tiff", units = "in", width = 10, height = 5, res = 300)
love.plot(formula,
  data = baseline,
  weights = m.out0,
  binary = "std",
  thresholds = c(m = .1, ks = .05, v = 2),
  colors = branding_colours,
  var.names = new_names,
  sample.names = c("Full sample", "Matched controls"),
  line = T
)
dev.off()


bal.tab(
  formula,
  data = baseline,
  weights = m.out0
)

md <- match_data(m.out0)

md <- md %>%
  mutate(
    treated = case_when(
      treated == TRUE ~ 1,
      treated == FALSE ~ 0
    ),
    treat_level = case_when(
      Amount_21_22 < 3 ~ 2,
      Amount_21_22 > 2 ~ 1,
      is.na(Amount_21_22) ~ 0
    ),
    qof_percent = qof_percent / 100,
    qof_percent_POST_INT = qof_percent_POST_INT / 100,
    treated = as.factor(treated),
    treat_level = as.factor(treat_level)
  )

### saved matched data for table 1, crude comparisons and sensitivity analyses
saveRDS(md, "matched_data_noPMS.rds")

### main model

main_model <- function(outcome, preintervention) {
  print(outcome)

  comparison <- "~ treated * ("
  variable_att <- "treated"

  unbalanced_variables <- c("PERC_MALE", "chi")
  final_covariates <- unique(c(preintervention, unbalanced_variables))
  formula <- as.formula(paste(outcome, paste(comparison, paste(final_covariates, collapse = " + "), ")")))

  if (preintervention %in% c("q28_12pct", "q18_12pct", "q90_12pct", "qof_percent")) {
    fit <- glm(formula, data = md, family = quasibinomial())
  } else if (preintervention %in% c("total_gp_extg_fte_weighted", "total_nurses_fte_weighted", "total_admin_fte_weighted")) {
    fit <- glm(formula, data = md, family = "quasipoisson")
  }

  ATT <- avg_comparisons(fit,
    variables = variable_att,
    vcov = ~subclass,
    newdata = subset(treated == 1)
  )


  ATT_tidy <- as.data.frame(ATT) %>%
    mutate(
      out = outcome,
      form = Reduce(paste, deparse(formula))
    )
}

binary_interaction <- mapply(main_model, outcome = outcomes, preintervention = preintervention_outcomes, SIMPLIFY = FALSE)

all_main_models <- do.call(rbind, binary_interaction)

saveRDS(all_main_models, "main_models_noPMS.rds")


